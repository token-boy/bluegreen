variables:
  CONTAINER_IMAGE: $REG/$CI_PROJECT_NAME:$CI_COMMIT_SHORT_SHA
  CONTAINER_NAME: $CI_PROJECT_NAME

build:
  tags:
    - ci-test
  script:
    - docker build --tag $CONTAINER_IMAGE .
    - docker push $CONTAINER_IMAGE

deploy:
  stage: deploy
  tags:
    - ci-test
  variables:
    DOCKER_HOST: $JOYRESERVE_DEMO
  script:
    - docker pull $CONTAINER_IMAGE
    - OLD_CONTAINER_NAME=$(docker ps  -a --format "{{.Names}}" | grep $CONTAINER_NAME)
    - docker run --detach
      --name=$CONTAINER_NAME
      --net=test
      --label="traefik.enable=true"
      --label="traefik.http.routers.$CONTAINER_NAME-$CI_COMMIT_SHORT_SHA.rule=Host(\`$CONTAINER_NAME.reserve.sya.org.cn\`)"
      --label="traefik.http.routers.$CONTAINER_NAME-$CI_COMMIT_SHORT_SHA.tls.certResolver=myresolver"
      --label="traefik.http.routers.$CONTAINER_NAME-$CI_COMMIT_SHORT_SHA-http.rule=Host(\`$CONTAINER_NAME.reserve.sya.org.cn\`)"
      --label="traefik.http.routers.$CONTAINER_NAME-$CI_COMMIT_SHORT_SHA-http.middlewares=redirect-https@file"
      --volume="/etc/localtime:/etc/localtime:ro"
      $CONTAINER_IMAGE
    - docker stop $OLD_CONTAINER_NAME || true
    - docker rm --force $OLD_CONTAINER_NAME || true
